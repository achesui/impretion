name: Deploy to Cloudflare Workers

# ‚úÖ PASO 1: Definir cu√°ndo se ejecuta
on:
  push:
    branches:
      - "main"
    # ‚úÖ OPCIONAL: Solo ejecutar cuando cambien archivos espec√≠ficos
    paths:
      - "apps/worker/dashboard/**" # Ajusta la ruta seg√∫n tu monorepo
      - "packages/**" # Si tienes dependencias compartidas
      - "pnpm-lock.yaml" # Si cambia el lockfile
      - "package.json" # Si cambian dependencias

# ‚úÖ PASO 2: Permisos necesarios para deployments
permissions:
  contents: read
  deployments: write

jobs:
  deploy-dashboard:
    runs-on: ubuntu-latest
    name: Deploy Dashboard Worker

    steps:
      # ‚úÖ PASO 3: Checkout del c√≥digo
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ‚úÖ PASO 4: Setup pnpm ANTES que Node.js (CR√çTICO)
      - name: Setup pnpm
        uses: pnpm/action-setup@v4 # ‚úÖ Versi√≥n m√°s reciente de la action
        with:
          version: 9 # ‚úÖ Tu versi√≥n exacta (puedes usar 9.x.x para m√°s flexibilidad)

      # ‚úÖ PASO 5: Setup Node.js CON cache de pnpm
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm" # ‚úÖ Esto acelera MUCHO las builds

      # ‚úÖ PASO 6: Verificar versiones (opcional, para debugging)
      - name: Verify versions
        run: |
          node --version
          pnpm --version
          echo "Cache directory: $(pnpm store path)"

      # ‚úÖ PASO 7: Install con frozen-lockfile (LA MEJOR PR√ÅCTICA)
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
        # ‚úÖ --frozen-lockfile asegura builds reproducibles
        # ‚úÖ Falla si el lockfile no coincide con package.json

      # ‚úÖ PASO 8: Deploy espec√≠fico al worker
      - name: Deploy @worker/dashboard
        run: pnpm turbo run deploy --filter=@worker/dashboard
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # ‚úÖ PASO 9: Verificar deployment (opcional)
      - name: Verify Deployment
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üöÄ Worker deployed to Cloudflare"
